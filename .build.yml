image: archlinux
secrets:
  - 3d68c1a1-174a-49be-b03b-af1a5d4bbd99
tasks:
  - get_zola: |
      version='v0.10.1'
      archive="zola-${version}-x86_64-unknown-linux-gnu.tar.gz"
      curl -L "https://github.com/getzola/zola/releases/download/${version}/${archive}" -o "$archive"
      tar xf "$archive"
  - build: |
      PATH="$PATH:$PWD"
      cd ruma.github.io
      zola build
  - deploy: |
      head_rev=$(git rev-parse HEAD)
      source_rev=$(git rev-parse source)
      if [[ "$head_rev" = "$source_rev" ]]; then
        exit 0
      fi

      echo 'Host *' >> ~/.ssh/config
      echo '    StrictHostKeyChecking=no' >> ~/.ssh/config

      PATH="$PATH:$PWD"
      cd ruma.github.io/public

      git config --global user.email "noreply@ruma.io"
      git config --global user.name "CI"
      git init
      git add -A
      git commit -m "Add files generated by zola"
      git push -f git@github.com:ruma/ruma.github.io master:gh-pages
  # Links can break in old articles. This should be checked in CI, but should
  # not break publishing new articles, so it is done after deploying the site.
  - check_links: |
      PATH="$PATH:$PWD"
      cd ruma.github.io
      zola check
